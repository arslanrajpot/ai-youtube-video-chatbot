<!DOCTYPE html>
<html lang="en">
<head>
    <title>TubeMuseAI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .chat-container { max-height: 500px; overflow-y: auto; }
        .chat-message { margin-bottom: 1rem; padding: 1rem; border-radius: 10px; }
        .user-message { background-color: #d1e7dd; }
        .bot-message { background-color: #e9ecef; }
        .form-container { padding: 2rem; background-color: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">YouTube Video Talk</h1>
        <div class="row">
            <div class="col-md-6 form-container">
                <h3>Submit Video</h3>
                <form id="video-form" class="mb-4">
                    <div class="mb-3">
                        <label for="youtube_url" class="form-label">YouTube URL</label>
                        <input type="url" class="form-control" id="youtube_url" name="youtube_url" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="submit-video-btn">Submit Video</button>
                    <div class="spinner-border text-primary mt-3 d-none" id="video-loading-spinner" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div id="video-status" class="mt-3"></div>
                </form>
                <h3>Ask a Question</h3>
                <form id="question-form">
                    <div class="mb-3">
                        <label for="question" class="form-label">Your Question</label>
                        <input type="text" class="form-control" id="question" name="question" required>
                        <input type="hidden" id="video_id" name="video_id" value="">
                    </div>
                    <button type="submit" class="btn btn-primary" id="submit-question-btn">Ask Question</button>
                    <div class="spinner-border text-primary mt-3 d-none" id="question-loading-spinner" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </form>
            </div>
            <div class="col-md-6">
                <h3>Chat</h3>
                <div class="chat-container" id="chat-container">
                    <!-- Chat messages will be appended here -->
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentVideoId = '';

        // Handle video submission
        document.getElementById('video-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-video-btn');
            const spinner = document.getElementById('video-loading-spinner');
            const statusDiv = document.getElementById('video-status');
            submitBtn.disabled = true;
            spinner.classList.remove('d-none');
            statusDiv.innerHTML = '';

            const formData = new FormData(this);
            try {
                const response = await fetch('/submit_video', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.status === 'success') {
                    statusDiv.innerHTML = '<div class="alert alert-success">Video transcript stored successfully!</div>';
                    currentVideoId = document.getElementById('youtube_url').value.split('v=')[1]?.split('&')[0] || '';
                    document.getElementById('video_id').value = currentVideoId;
                } else {
                    statusDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger">Error submitting video.</div>';
            } finally {
                submitBtn.disabled = false;
                spinner.classList.add('d-none');
            }
        });

        // Handle question submission
        document.getElementById('question-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-question-btn');
            const spinner = document.getElementById('question-loading-spinner');
            submitBtn.disabled = true;
            spinner.classList.remove('d-none');

            const question = document.getElementById('question').value;
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML += `<div class="chat-message user-message">You: ${question}</div>`;
            chatContainer.scrollTop = chatContainer.scrollHeight;

            const formData = new FormData(this);
            try {
                const response = await fetch('/ask_question', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.status === 'success') {
                    await typeWriterEffect(result.answer);
                } else {
                    chatContainer.innerHTML += `<div class="chat-message bot-message">Bot: ${result.message}</div>`;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            } catch (error) {
                chatContainer.innerHTML += '<div class="chat-message bot-message">Bot: Error processing question.</div>';
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } finally {
                submitBtn.disabled = false;
                spinner.classList.add('d-none');
                document.getElementById('question').value = '';
            }
        });

        // Typewriter effect for bot response
        async function typeWriterEffect(text) {
            const chatContainer = document.getElementById('chat-container');
            const botMessageDiv = document.createElement('div');
            botMessageDiv.className = 'chat-message bot-message';
            botMessageDiv.innerHTML = 'Bot: ';
            chatContainer.appendChild(botMessageDiv);

            const lines = text.split('\n').filter(line => line.trim());
            for (const line of lines) {
                for (const char of line) {
                    botMessageDiv.innerHTML += char;
                    await new Promise(resolve => setTimeout(resolve, 30));
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                botMessageDiv.innerHTML += '<br>';
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>
</body>
</html>